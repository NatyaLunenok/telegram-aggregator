**Техническая документация: Агрегатор коммуникаций Telegram**

-----
1. **Общая информация о проекте**

**Название проекта:** Агрегатор коммуникаций Telegram

**Описание:** Программный комплекс, предназначенный для сбора, фильтрации и хранения сообщений из Telegram-чатов и каналов. Система позволяет автоматически парсить входящие сообщения, обрабатывать вложения, извлекать метаданные и сохранять информацию в реляционной базе данных PostgreSQL.

**Технологический стек:** 

- **Язык программирования:** Python 3.9 
- **Библиотека для работы с Telegram API:** TDLib через Python-обертку python-telegram-client
- **База данных:** PostgreSQL 
- **Контейнеризация:** Docker, Docker Compose 
- **Библиотеки Python:** psycopg2-binary (для работы с PostgreSQL), python-dotenv (для управления переменными окружения), loguru (для логирования).
2. **Архитектура системы**

Система состоит из нескольких ключевых компонентов, взаимодействующих между собой:

- **Клиент TDLib:** ядро, обеспечивающее связь с Telegram API. Отвечает за получение обновлений (новые сообщения, изменения статусов и т.д.).
- **Модуль обработки сообщений (MessageHandler):** отвечает за парсинг входящих сообщений, извлечение нужной информации (текст, отправитель, дата, вложения, ответы, пересылки) и применение фильтров.
- **Модуль работы с данными (DataStorage):** обеспечивает взаимодействие с базой данных PostgreSQL. Отвечает за сохранение, обновление и извлечение данных.
- **Модуль предварительной загрузки данных (ChatPreloader):** инициализируется при старте программы. Отвечает за загрузку и актуализацию информации о разрешенных чатах и их участниках (пользователях) перед началом основного парсинга.
- **Конфигурация (config.py):** хранит все настройки проекта: API ID, API Hash, номер телефона, URL подключения к БД, пути к библиотекам, список разрешенных чатов.
- **База данных PostgreSQL:** хранит всю собранную информацию (пользователи, чаты, сообщения, вложения, реакции и т.д.).
- **Docker & Docker Compose:** используются для упаковки приложения и базы данных в изолированные контейнеры, обеспечивая простоту развертывания и управления.
3. **Описание модулей и их функциональность**

**3.1. main.py**

**Назначение:** Точка входа в приложение. Оркестрирует работу всех основных компонентов.

**Функциональность:**

- Инициализация клиента Telegram (Telegram с использованием Config, api\_id, api\_hash, phone).
- Авторизация пользователя Telegram (tg.login()).
- Инициализация хранилища данных (DataStorage) и установление соединения с БД.
- Инициализация модуля предварительной загрузки чатов (ChatPreloader) и запуск процесса загрузки данных (preload\_allowed\_chats\_data).
- Инициализация обработчика сообщений (MessageHandler).
- Регистрация callback-функции new\_message\_handler для обработки входящих обновлений от TDLib.
- Запуск бесконечного цикла ожидания обновлений (tg.idle()).

**3.2. message\_handler.py (Класс MessageHandler)**

**Назначение:** Обработка полученных сообщений Telegram.

**Функциональность:**

Метод process\_message(message, data\_storage):

- Принимает объект сообщения и экземпляр DataStorage.
- Извлекает ключевую информацию из сообщения: ID сообщения, ID чата, ID отправителя, текст, вложения, информацию об ответе/пересылке, временные метки.
- Применяет к сообщению функцию фильтрации is\_relevant() для определения, нужно ли его сохранять.
- При необходимости, обрабатывает вложения, извлекая их типы и сохраняя в соответствующие таблицы.
- Сохраняет отфильтрованное и обработанное сообщение в базу данных через data\_storage.save\_regular\_message().

**3.3. data\_storage.py (Класс DataStorage)**

**Назначение:** Управление взаимодействием с базой данных PostgreSQL.

**Функциональность:**

- Инициализация с подключением к БД (psycopg2.connect).
- Предоставление методов для выполнения SQL-запросов:
  - save\_regular\_message(): сохранение информации о сообщении
  - save\_attachment(): сохранение информации о вложениях
- Обработка транзакций для обеспечения целостности данных.

**3.4. chat\_preloader.py (Класс ChatPreloader)**

**Назначение**: Первичная загрузка и актуализация данных о разрешенных чатах и их участниках при старте приложения.

**Функциональность:**

- Инициализация с клиентом Telegram и подключением к БД.
- Метод preload\_allowed\_chats\_data():
  - Проходит по списку Config.ALLOWED\_CHATS.
  - Для каждого чата вызывает load\_and\_update\_chat\_data().
- Метод load\_and\_update\_chat\_data(chat\_id):
  - Получает информацию о чате с помощью tg.get\_chat(chat\_id).
  - Обрабатывает полученные данные, извлекая ID чата, его тип и название.
  - Вызывает upsert\_chat\_info() для сохранения/обновления данных о чате в БД.

**3.5. config.py**

**Назначение**: Централизованное хранилище всех конфигурационных параметров. Все параметры загружаются из файла .env с помощью библиотеки python-dotenv.

**Содержимое:**

- API\_ID, API\_HASH: ключи доступа к Telegram API, полученные с my.telegram.org/apps.
- PHONE\_NUMBER: номер телефона, привязанный к аккаунту Telegram, используемый для авторизации.
- TDLIB\_PATH: путь к скомпилированной библиотеке TDLib.
- DB\_HOST, DB\_PORT, POSTGRES\_USER, POSTGRES\_PASSWORD, POSTGRES\_DB: параметры для подключения к базе данных PostgreSQL.
- DB\_URL: полная строка подключения к базе данных, формируется автоматически на основе вышеуказанных параметров, если не указана напрямую в .env.
- ALLOWED\_CHATS: список целочисленных ID чатов, из которых разрешен сбор данных. Чаты, не входящие в этот список, будут игнорироваться.
- BLOCKED\_USERS: список целочисленных ID пользователей, чьи сообщения будут игнорироваться, даже если они находятся в разрешенных чатах.
- KEYWORDS: список ключевых слов (строк). Сообщения, содержащие хотя бы одно из этих слов, будут считаны как релевантные.
- FLAG\_WORDS: список "флаговых" слов. Сообщения, содержащие хотя бы одно из этих слов, будут считаны как релевантные.
- SAVE\_ATTACHMENTS: логический флаг (True/False), указывающий, следует ли сохранять информацию о вложениях сообщений.
- IGNORE\_BOTS: логический флаг (True/False), указывающий, следует ли игнорировать сообщения, отправленные ботами.

**3.6. requirements.txt**

**Назначение:** Перечень всех Python-библиотек, необходимых для работы приложения, с указанием их версий.

**3.7. Dockerfile.app**

**Назначение:** Инструкция по сборке Docker-образа для самого приложения.

**Функциональность:**

- Определяет базовый образ (python:3.9-alpine).
- Устанавливает системные зависимости для компиляции TDLib и работы Python.
- Компилирует TDLib из исходных кодов, устанавливая ее в /usr/local.
- Устанавливает Python-зависимости из requirements.txt.
- Копирует исходный код приложения в образ.
- Определяет команду запуска (CMD).

**3.8. docker-compose.yml**

**Назначение:** Описание и управление конфигурацией сервисов приложения (в данном случае, только PostgreSQL).

**Функциональность:**

- Определяет сервис базы данных PostgreSQL, включая используемый образ, порты, тома для персистентности данных и автоматическую инициализацию схемы из SQL-файлов.
- Использует .env файл для безопасного хранения учетных данных базы данных.
4. **Важная информация о проекте**
   - Все приложение и база данных работают в изолированных Docker-контейнерах, что обеспечивает удобство развертывания, изоляцию и воспроизводимость окружения.
   - Данные базы данных PostgreSQL сохраняются с помощью Docker Volumes, что гарантирует их сохранность даже при перезапуске или удалении контейнера.
   - Агрегатор работает в режиме реального времени, получая обновления от Telegram API непосредственно после их отправки.
   - Гибкая система фильтрации (is\_relevant) позволяет настроить сбор данных только из нужных чатов или сообщений, что оптимизирует процесс и объем хранимых данных.
   - Для работы агрегатора используется реальный аккаунт Telegram, что требует его авторизации при первом запуске.



<br><br><br>


**Руководство пользователя: Агрегатор коммуникаций Telegram**

-----
Добро пожаловать в руководство пользователя агрегатора коммуникаций Telegram! Данное руководство поможет вам понять, как использовать приложение для сбора и хранения информации из ваших Telegram-чатов.

1. **Начало работы**

**1.1. Системные требования**

- Установленный Docker и Docker Compose.
- Аккаунт Telegram.
- Номер телефона, привязанный к вашему Telegram-аккаунту.

**1.2. Регистрация Telegram API**

Перед первым запуском агрегатора вам необходимо получить ключи доступа к Telegram API:

1. Перейдите на сайт <https://my.telegram.org/apps>.
1. Войдите, используя номер телефона вашего Telegram-аккаунта.
1. Создайте новое приложение, заполнив необходимые поля (например, «App title» и «Short name»).
1. После создания приложения вы получите API ID и API Hash. Сохраните их в надежном месте, они понадобятся для настройки.

**1.3. Конфигурация приложения**


**1.3.1. Настройка Docker Compose:**
   - В файле docker-compose.yml найдите секцию environment для сервиса db.
   - Создайте файл .env в том же каталоге, где находится docker-compose.yml.
   - В файле .env пропишите следующие строки, заменив значения на свои: dotenv POSTGRES\_DB=your\_db\_name POSTGRES\_USER=your\_db\_user POSTGRES\_PASSWORD=your\_db\_password (Эти данные также нужно будет указать в config.py, если это требуется для подключения приложения к БД).

**1.3.2. Настройка файла config.py:**
   - Откройте файл config.py в папке src.
   - Введите полученные API ID и API Hash в соответствующие поля (API\_ID, API\_HASH).
   - Укажите ваш номер телефона (PHONE\_NUMBER).
   - Проверьте и при необходимости укажите корректный DB\_URL для подключения к базе данных PostgreSQL.
   - Заполните ALLOWED\_CHATS — это список ID чатов, из которых агрегатор будет собирать сообщения. Чтобы узнать ID чата, вы можете использовать специальные боты или сторонние клиенты Telegram.
2. **Запуск агрегатора**
     
**2.1. Сборка Docker-образа:**
   - Откройте терминал или командную строку.
   - Перейдите в корневую директорию проекта, где находится Dockerfile.app и docker-compose.yml.
   - Выполните команду для сборки образа приложения: bash docker build -t telegram-aggregator-app -f Dockerfile.app. (Эта команда может занять некоторое время, так как будет компилироваться TDLib).
     
**2.2. Запуск контейнеров:**

   Выполните команду для запуска контейнера PostgreSQL и приложения: bash docker-compose up -d (Флаг -d запускает контейнеры в фоновом режиме).

**2.3. Авторизация Telegram:**

   При первом запуске агрегатор запросит код подтверждения, отправленный на ваш номер Telegram. Введите его в консоль, где запущены контейнеры (если они не в фоновом режиме) или в логах Docker.

   Если у вас включена двухфакторная аутентификация, также потребуется ввести пароль.

3. **Как работает агрегатор**
   - **Сбор данных:** после успешной авторизации агрегатор начнет собирать сообщения из чатов, указанных в ALLOWED\_CHATS.
   - **Фильтрация:** сообщения, не соответствующие заданным фильтрам (например, не из разрешенных чатов, не содержащие ключевых слов), обрабатываться не будут.
   - **Хранение данных:** все отфильтрованные и обработанные сообщения, а также информация о пользователях и чатах, сохраняются в базе данных PostgreSQL.
   - **Обновление данных:** при запуске агрегатор предварительно загружает актуальную информацию о разрешенных чатах и их участниках.
1. **Остановка агрегатора**

Чтобы остановить агрегатор, выполните в терминале команду:

docker-compose down

Эта команда остановит и удалит контейнеры, созданные Docker Compose.

5. **Важная информация**
- Никогда не передавайте свои API ID, API Hash и пароль от Telegram третьим лицам.
- Размер базы данных может расти очень быстро, особенно при мониторинге большого количества чатов. Регулярно проверяйте свободное место на диске.
- Будьте внимательны к лимитам, установленным Telegram API, чтобы избежать блокировки аккаунта.

